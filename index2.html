<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Roadmap Timeline</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #f0f2f5 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
    }

    h1 {
      color: #2d3748;
      margin-bottom: 25px;
      font-size: 28px;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .controls-row {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .compact-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: auto;
      padding: 8px 12px;
      background: #f7fafc;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
    }

    .compact-toggle input[type="checkbox"] {
      cursor: pointer;
    }

    .compact-toggle label {
      cursor: pointer;
      font-size: 14px;
      color: #4a5568;
      font-weight: 600;
    }

    .controls input,
    .controls select,
    .controls button,
    .controls-row input,
    .controls-row select,
    .controls-row button {
      padding: 10px 15px;
      border: 1px solid #e8ecef;
      border-radius: 12px;
      font-size: 14px;
      transition: all 0.2s;
      background: white;
    }

    .controls input:focus,
    .controls select:focus,
    .controls-row input:focus,
    .controls-row select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .controls button,
    .controls-row button {
      background: white;
      color: #667eea;
      border: 1px solid #667eea;
      cursor: pointer;
      font-weight: 600;
    }

    .controls button:hover,
    .controls-row button:hover {
      background: #f5f7fa;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }

    .btn-milestone {
      border-color: #667eea !important;
      color: #667eea !important;
    }

    .btn-milestone:hover {
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15) !important;
    }

    .timeline-container {
      overflow-x: auto;
      margin-top: 20px;
    }

    .timeline {
      min-width: 800px;
      position: relative;
      background: white;
    }

    .timeline-grid {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 0;
    }

    .month-background {
      position: absolute;
      top: 0;
      bottom: 0;
      pointer-events: none;
    }

    .month-background.even {
      background: #f9fafc;
    }

    .month-background.odd {
      background: white;
    }

    .grid-line {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 1px;
      pointer-events: none;
    }

    .grid-line.month {
      background: #e8ecef;
      z-index: 2;
    }

    .grid-line.week {
      background: #f0f2f5;
      z-index: 1;
    }

    .grid-line.milestone {
      background: #667eea;
      width: 2px;
      z-index: 3;
      opacity: 0.4;
    }

    .milestone-marker {
      position: absolute;
      top: 0;
      z-index: 10;
      cursor: pointer;
      transform: translateX(-50%);
    }

    .milestone-flag {
      width: 20px;
      height: 16px;
      background: #667eea;
      position: relative;
      clip-path: polygon(0 0, 100% 0, 100% 70%, 50% 100%, 0 70%);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .milestone-pole {
      width: 2px;
      height: 8px;
      background: #667eea;
      margin: 0 auto;
    }

    .milestone-label {
      position: absolute;
      top: 0px;
      left: 50%;
      transform: translateX(-50%);
      background: #667eea;
      color: white;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 10px;
      font-weight: 600;
      white-space: nowrap;
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .milestone-marker:hover .milestone-flag {
      background: #764ba2;
    }

    .milestone-marker:hover .milestone-label {
      background: #764ba2;
    }

    .milestones-row {
      position: relative;
      height: 20px;
      margin-bottom: 8px;
    }

    .timeline-content {
      position: relative;
      z-index: 3;
    }

    .timeline-header {
      display: flex;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 10px;
      margin-bottom: 15px;
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
    }

    .timeline-month {
      flex: 1;
      text-align: center;
      font-weight: 600;
      color: #4a5568;
      font-size: 13px;
    }

    .timeline-row {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      position: relative;
      height: 36px;
      cursor: move;
      padding-left: 30px;
    }

    .drag-handle {
      position: absolute;
      left: 5px;
      color: #a0aec0;
      cursor: grab;
      font-size: 16px;
    }

    .drag-handle:active {
      cursor: grabbing;
    }

    .timeline-row.dragging {
      opacity: 0.5;
    }

    .timeline-row.drag-over {
      border-top: 3px solid #667eea;
    }

    .task-bar {
      position: absolute;
      height: 32px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      padding: 0 12px;
      cursor: pointer;
      transition: all 0.2s;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .task-bar:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
      z-index: 5;
    }

    .tooltip {
      position: absolute;
      background: #2d3748;
      color: white;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 12px;
      pointer-events: none;
      z-index: 1000;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      opacity: 0;
      transition: opacity 0.2s;
      max-width: 320px;
      word-wrap: break-word;
    }

    .tooltip.visible {
      opacity: 1;
    }

    .tooltip-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .tooltip-dates {
      font-size: 11px;
      color: #cbd5e0;
    }

    .task-title {
      color: white;
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
    }

    .modal-content h2 {
      margin-bottom: 20px;
      color: #2d3748;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #4a5568;
      font-weight: 600;
      font-size: 14px;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #e8ecef;
      border-radius: 12px;
      font-size: 14px;
      background: white;
      transition: all 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .color-options {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .color-option {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s;
    }

    .color-option:hover {
      transform: scale(1.1);
    }

    .color-option.selected {
      border-color: #2d3748;
      transform: scale(1.1);
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .modal-buttons button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-save {
      background: #667eea;
      color: white;
    }

    .btn-delete {
      background: #fecaca;
      color: #7f1d1d;
    }

    .btn-cancel {
      background: #f0f2f5;
      color: #4a5568;
    }

    .btn-save:hover {
      background: #764ba2;
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.2);
    }

    .btn-delete:hover {
      background: #fca5a5;
      box-shadow: 0 6px 20px rgba(252, 202, 202, 0.2);
    }

    .btn-cancel:hover {
      background: #e8ecef;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #a0aec0;
    }

    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .section-label {
      font-size: 12px;
      color: #718096;
      font-weight: 600;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .zoom-container {
      /* margin-bottom: 20px; */
      /* padding: 15px; */
      background: white;
      /* border-radius: 14px; */
      /* border: 1px solid #e8ecef; */
      display: flex;
      gap: 12px;
      align-items: center;
      /* box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); */
    }

    .zoom-slider-wrapper {
      flex: 1;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .zoom-label {
      font-size: 11px;
      color: #718096;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    .zoom-track {
      flex: 1;
      position: relative;
      height: 40px;
      display: flex;
      align-items: center;
    }

    .zoom-slider {
      position: absolute;
      width: 100%;
      height: 40px;
      -webkit-appearance: none;
      appearance: none;
      background: transparent;
      border: none;
      outline: none;
      cursor: pointer;
    }

    #zoomStartSlider {
      z-index: 5;
    }

    #zoomEndSlider {
      z-index: 4;
    }

    #zoomStartSlider:focus {
      z-index: 7;
    }

    #zoomEndSlider:focus {
      z-index: 7;
    }

    .zoom-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: white;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      border: 3px solid #667eea;
    }

    .zoom-slider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: white;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      border: 3px solid #667eea;
    }

    .zoom-range-track {
      position: absolute;
      height: 4px;
      background: #e8ecef;
      border-radius: 2px;
      top: 50%;
      transform: translateY(-50%);
      width: 100%;
      left: 0;
    }

    .zoom-range-fill {
      position: absolute;
      height: 4px;
      background: #667eea;
      border-radius: 2px;
      top: 50%;
      transform: translateY(-50%);
    }

    .zoom-values {
      display: flex;
      gap: 4px;
      align-items: center;
      font-size: 12px;
      color: #2d3748;
      font-weight: 600;
      padding: 6px 12px;
      background: #f9fafc;
      border: 1px solid #e8ecef;
      border-radius: 10px;
      min-width: 180px;
      justify-content: center;
    }

    .zoom-value-item {
      padding: 0 4px;
    }

    .zoom-arrow {
      color: #cbd5e0;
      font-size: 10px;
    }

    .zoom-reset-btn {
      padding: 8px 14px;
      background: white;
      color: #667eea;
      border: 1px solid #667eea;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .zoom-reset-btn:hover {
      background: #f5f7fa;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }

    .top-bar {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: flex-end;
      margin-bottom: 20px;
      padding: 12px 16px;
      background: white;
      border: 1px solid #e8ecef;
      border-radius: 14px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .top-bar button,
    .top-bar label {
      padding: 8px 14px;
      background: white;
      color: #667eea;
      border: 1px solid #667eea;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .top-bar button:hover,
    .top-bar label:hover {
      background: #f5f7fa;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }

    .top-bar .compact-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-left: 0;
      padding: 8px 14px;
      background: white;
      border: 1px solid #667eea;
      border-radius: 10px;
    }

    .top-bar .compact-toggle input {
      cursor: pointer;
      margin: 0;
    }

    .top-bar .compact-toggle label {
      padding: 0;
      background: none;
      border: none;
      color: #667eea;
      margin: 0;
    }

    .top-bar .compact-toggle label:hover {
      background: none;
      border: none;
    }

    .main-content {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="top-bar">
      <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="importCSV(event)">
      <button onclick="document.getElementById('csvFile').click()">üìÅ Import CSV</button>
      <button class="btn-milestone" onclick="openAddMilestoneModal()">üö© Add Milestone</button>
      <div class="compact-toggle">
        <input type="checkbox" id="compactMode" onchange="toggleCompactMode()">
        <label for="compactMode">Compact View</label>
      </div>
    </div>

    <div class="main-content">
      <div class="controls">
        <input type="text" id="taskTitle" placeholder="Task title" style="flex: 2; min-width: 200px;">
        <input type="date" id="startDate">
        <input type="number" id="duration" placeholder="Weeks" min="1" style="width: 100px;">
        <button onclick="addTask()">+ Add Task</button>
      </div>

      <div class="zoom-container">
        <span class="zoom-label">Zoom Range</span>
        <div class="zoom-slider-wrapper">
          <div class="zoom-track">
            <div class="zoom-range-track">
              <div class="zoom-range-fill" id="zoomRangeFill"></div>
            </div>
            <input type="range" id="zoomStartSlider" class="zoom-slider" min="0" max="100" value="0"
              oninput="updateZoomStart(this.value)">
            <input type="range" id="zoomEndSlider" class="zoom-slider" min="0" max="100" value="100"
              oninput="updateZoomEnd(this.value)">
          </div>
          <div class="zoom-values">
            <span class="zoom-value-item" id="zoomStartValue"></span>
            <span class="zoom-arrow">‚Üí</span>
            <span class="zoom-value-item" id="zoomEndValue"></span>
          </div>
        </div>
        <button class="zoom-reset-btn" onclick="resetZoom()">Reset</button>
      </div>

      <div class="timeline-container">
        <div id="timeline" class="timeline"></div>
      </div>
    </div>

    <div id="tooltip" class="tooltip">
      <div class="tooltip-title"></div>
      <div class="tooltip-dates"></div>
    </div>
  </div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <h2>Task Details</h2>
      <div class="form-group">
        <label>Title</label>
        <input type="text" id="editTitle">
      </div>
      <div class="form-group">
        <label>Start Date</label>
        <input type="date" id="editStartDate">
      </div>
      <div class="form-group">
        <label>Duration (weeks)</label>
        <input type="number" id="editDuration" min="1">
      </div>
      <div class="form-group">
        <label>Color</label>
        <div class="color-options" id="colorOptions"></div>
      </div>
      <div class="modal-buttons">
        <button class="btn-save" onclick="saveTask()">Save</button>
        <button class="btn-delete" onclick="deleteTask()">Delete</button>
        <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>

  <div id="addMilestoneModal" class="modal">
    <div class="modal-content">
      <h2>Add Milestone</h2>
      <div class="form-group">
        <label>Milestone Date</label>
        <input type="date" id="newMilestoneDate">
      </div>
      <div class="form-group">
        <label>Milestone Label</label>
        <input type="text" id="newMilestoneLabel" placeholder="e.g., Product Launch">
      </div>
      <div class="modal-buttons">
        <button class="btn-save" onclick="saveMilestoneFromModal()">Add</button>
        <button class="btn-cancel" onclick="closeAddMilestoneModal()">Cancel</button>
      </div>
    </div>
  </div>

  <div id="milestoneModal" class="modal">
    <div class="modal-content">
      <h2>Edit Milestone</h2>
      <div class="form-group">
        <label>Label</label>
        <input type="text" id="editMilestoneLabel">
      </div>
      <div class="form-group">
        <label>Date</label>
        <input type="date" id="editMilestoneDate">
      </div>
      <div class="modal-buttons">
        <button class="btn-save" onclick="saveMilestone()">Save</button>
        <button class="btn-delete" onclick="deleteMilestone()">Delete</button>
        <button class="btn-cancel" onclick="closeMilestoneModal()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const colors = [
      '#667eea', '#f093fb', '#4facfe', '#fa709a', '#ff6b6b',
      '#c44569', '#f8b500', '#48bb78', '#ed8936', '#9f7aea'
    ];

    let tasks = [];
    let milestones = [];
    let editingTaskId = null;
    let editingMilestoneId = null;
    let compactMode = false;
    let zoomStartMonth = null;
    let zoomEndMonth = null;
    let availableMonths = [];
    const MS_PER_DAY = 1000 * 60 * 60 * 24;

    function toISODate(value) {
      if (!value) return '';
      if (/^\d{4}-\d{2}-\d{2}$/.test(value)) return value;
      const parsed = new Date(value);
      if (isNaN(parsed)) return '';
      return parsed.toISOString().slice(0, 10);
    }

    function loadTasks() {
      try {
        const stored = JSON.parse(localStorage.getItem('roadmapTasks') || '[]');
        tasks = (Array.isArray(stored) ? stored : []).map(t => {
          const normalized = toISODate(t.startDate) || t.startDate || '';
          return {
            id: t.id,
            title: t.title || '',
            startDate: normalized,
            duration: Number.isFinite(t.duration) ? t.duration : parseInt(t.duration) || 0,
            color: t.color || colors[Math.floor(Math.random() * colors.length)]
          };
        });
      } catch (err) {
        tasks = [];
      }
    }

    function loadMilestones() {
      try {
        const stored = JSON.parse(localStorage.getItem('roadmapMilestones') || '[]');
        milestones = (Array.isArray(stored) ? stored : []).map(m => ({
          id: m.id,
          label: m.label || '',
          date: toISODate(m.date) || m.date || ''
        }));
      } catch (err) {
        milestones = [];
      }
    }

    function saveTasks() {
      localStorage.setItem('roadmapTasks', JSON.stringify(tasks));
    }

    function saveMilestones() {
      localStorage.setItem('roadmapMilestones', JSON.stringify(milestones));
    }

    function openAddMilestoneModal() {
      document.getElementById('addMilestoneModal').classList.add('active');
    }

    function closeAddMilestoneModal() {
      document.getElementById('addMilestoneModal').classList.remove('active');
      document.getElementById('newMilestoneDate').value = '';
      document.getElementById('newMilestoneLabel').value = '';
    }

    function saveMilestoneFromModal() {
      const dateRaw = document.getElementById('newMilestoneDate').value;
      const label = document.getElementById('newMilestoneLabel').value.trim();
      const date = toISODate(dateRaw);

      if (!date || !label) {
        alert('Please provide both a date and label for the milestone');
        return;
      }

      const milestone = {
        id: Date.now(),
        date,
        label
      };

      milestones.push(milestone);
      saveMilestones();
      renderTimeline();
      closeAddMilestoneModal();
    }

    function addMilestone() {
      saveMilestoneFromModal();
    }

    function openMilestoneModal(milestoneId) {
      const milestone = milestones.find(m => m.id === milestoneId);
      if (!milestone) return;

      editingMilestoneId = milestoneId;
      document.getElementById('editMilestoneLabel').value = milestone.label || '';
      document.getElementById('editMilestoneDate').value = toISODate(milestone.date) || '';

      document.getElementById('milestoneModal').classList.add('active');
    }

    function closeMilestoneModal() {
      document.getElementById('milestoneModal').classList.remove('active');
      editingMilestoneId = null;
    }

    function saveMilestone() {
      const milestone = milestones.find(m => m.id === editingMilestoneId);
      if (!milestone) return;

      const newLabel = document.getElementById('editMilestoneLabel').value.trim();
      const newDateRaw = document.getElementById('editMilestoneDate').value;
      const newDate = toISODate(newDateRaw);

      if (!newLabel) {
        alert('Label cannot be empty');
        return;
      }
      if (!newDate) {
        alert('Please provide a valid date');
        return;
      }

      milestone.label = newLabel;
      milestone.date = newDate;

      saveMilestones();
      renderTimeline();
      closeMilestoneModal();
    }

    function deleteMilestone() {
      if (!confirm('Are you sure you want to delete this milestone?')) return;

      milestones = milestones.filter(m => m.id !== editingMilestoneId);
      saveMilestones();
      renderTimeline();
      closeMilestoneModal();
    }

    function updateZoomRangeFill() {
      const startVal = parseInt(document.getElementById('zoomStartSlider').value);
      const endVal = parseInt(document.getElementById('zoomEndSlider').value);
      const rangeFill = document.getElementById('zoomRangeFill');
      rangeFill.style.left = startVal + '%';
      rangeFill.style.width = (endVal - startVal) + '%';
    }

    function updateZoomStart(value) {
      if (availableMonths.length <= 1) return;

      let startIdx = Math.floor((parseInt(value) / 100) * availableMonths.length);
      startIdx = Math.min(startIdx, availableMonths.length - 1);

      const endIdx = Math.floor((parseInt(document.getElementById('zoomEndSlider').value) / 100) * availableMonths.length);

      if (startIdx > endIdx) {
        document.getElementById('zoomStartSlider').value = value;
        return;
      }

      zoomStartMonth = availableMonths[startIdx];
      const startStr = zoomStartMonth.toLocaleString('default', {month: 'short', year: 'numeric'});
      document.getElementById('zoomStartValue').textContent = startStr;
      updateZoomRangeFill();
      renderTimeline();
    }

    function updateZoomEnd(value) {
      if (availableMonths.length <= 1) return;

      let endIdx = Math.floor((parseInt(value) / 100) * availableMonths.length);
      endIdx = Math.min(endIdx, availableMonths.length - 1);

      const startIdx = Math.floor((parseInt(document.getElementById('zoomStartSlider').value) / 100) * availableMonths.length);

      if (endIdx < startIdx) {
        document.getElementById('zoomEndSlider').value = value;
        return;
      }

      zoomEndMonth = availableMonths[endIdx];
      const endStr = zoomEndMonth.toLocaleString('default', {month: 'short', year: 'numeric'});
      document.getElementById('zoomEndValue').textContent = endStr;
      updateZoomRangeFill();
      renderTimeline();
    }

    function resetZoom() {
      zoomStartMonth = null;
      zoomEndMonth = null;
      document.getElementById('zoomStartSlider').value = 0;
      document.getElementById('zoomEndSlider').value = 100;
      document.getElementById('zoomStartValue').textContent = '';
      document.getElementById('zoomEndValue').textContent = '';
      updateZoomRangeFill();
      renderTimeline();
    }

    function importCSV(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const text = e.target.result;
        const lines = text.split('\n').filter(line => line.trim());

        let startIndex = 0;
        if (lines.length && /title/i.test(lines[0]) && /start/i.test(lines[0])) {
          startIndex = 1;
        }

        for (let i = startIndex; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;

          const parts = line.split(',').map(p => p.trim().replace(/^["']|["']$/g, ''));

          if (parts.length >= 3) {
            const title = parts[0];
            const rawStart = parts[1];
            const duration = parseInt(parts[2]);

            const isoDate = toISODate(rawStart);

            if (title && isoDate && Number.isFinite(duration) && duration > 0) {
              tasks.push({
                id: Date.now() + i,
                title,
                startDate: isoDate,
                duration,
                color: colors[Math.floor(Math.random() * colors.length)]
              });
            }
          }
        }

        saveTasks();
        renderTimeline();
        event.target.value = '';
      };
      reader.readAsText(file);
    }

    function addTask() {
      const title = document.getElementById('taskTitle').value.trim();
      const startDateRaw = document.getElementById('startDate').value;
      const duration = parseInt(document.getElementById('duration').value);

      const startDate = toISODate(startDateRaw);

      if (!title || !startDate || !Number.isFinite(duration) || duration < 1) {
        alert('Please fill in all fields with valid values');
        return;
      }

      const task = {
        id: Date.now(),
        title,
        startDate,
        duration,
        color: colors[Math.floor(Math.random() * colors.length)]
      };

      tasks.push(task);
      saveTasks();
      renderTimeline();

      document.getElementById('taskTitle').value = '';
      document.getElementById('startDate').value = '';
      document.getElementById('duration').value = '';
    }

    function getEndDate(startDate, weeks) {
      const date = new Date(startDate);
      if (isNaN(date)) return new Date(NaN);
      date.setDate(date.getDate() + (Number.isFinite(weeks) ? weeks * 7 : 0));
      return date;
    }

    function formatDate(date) {
      if (!(date instanceof Date) || isNaN(date)) return 'Invalid date';
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    function showTooltip(e, task) {
      const tooltip = document.getElementById('tooltip');
      const tooltipTitle = tooltip.querySelector('.tooltip-title');
      const tooltipDates = tooltip.querySelector('.tooltip-dates');

      const startDate = new Date(task.startDate);
      const endDate = getEndDate(task.startDate, task.duration);

      tooltipTitle.textContent = task.title || '';
      tooltipDates.textContent = `${formatDate(startDate)} - ${formatDate(endDate)}`;

      tooltip.style.left = (e.pageX + 10) + 'px';
      tooltip.style.top = (e.pageY + 10) + 'px';
      tooltip.classList.add('visible');
    }

    function hideTooltip() {
      const tooltip = document.getElementById('tooltip');
      tooltip.classList.remove('visible');
    }

    function toggleCompactMode() {
      compactMode = document.getElementById('compactMode').checked;
      renderTimeline();
    }

    function tasksOverlap(task1, task2) {
      const start1 = new Date(task1.startDate);
      const end1 = getEndDate(task1.startDate, task1.duration);
      const start2 = new Date(task2.startDate);
      const end2 = getEndDate(task2.startDate, task2.duration);

      if (isNaN(start1) || isNaN(end1) || isNaN(start2) || isNaN(end2)) return false;

      return start1 < end2 && start2 < end1;
    }

    function groupTasksForCompactView(tasks) {
      const sortedTasks = [...tasks].sort((a, b) =>
        new Date(a.startDate) - new Date(b.startDate)
      );

      const groups = [];

      sortedTasks.forEach(task => {
        let placed = false;

        for (let group of groups) {
          let canPlace = true;

          for (let groupTask of group) {
            if (tasksOverlap(task, groupTask)) {
              canPlace = false;
              break;
            }
          }

          if (canPlace) {
            group.push(task);
            placed = true;
            break;
          }
        }

        if (!placed) {
          groups.push([task]);
        }
      });

      return groups;
    }

    function getMonthsBetween(start, end) {
      const months = [];
      const current = new Date(start.getFullYear(), start.getMonth(), 1);
      const endMonth = new Date(end.getFullYear(), end.getMonth(), 1);

      while (current <= endMonth) {
        months.push(new Date(current));
        current.setMonth(current.getMonth() + 1);
      }

      return months;
    }

    function clamp01(v) {
      return Math.max(0, Math.min(100, v));
    }

    function renderTimeline() {
      const timeline = document.getElementById('timeline');

      if ((!tasks || tasks.length === 0) && (!milestones || milestones.length === 0)) {
        timeline.innerHTML = `
          <div class="empty-state">
            <svg fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/></svg>
            <p>No tasks yet. Add your first task to get started!</p>
          </div>
        `;
        return;
      }

      const allDates = [
        ...tasks.flatMap(t => {
          const s = new Date(t.startDate);
          const e = getEndDate(t.startDate, t.duration);
          return [s, e];
        }),
        ...milestones.map(m => new Date(m.date))
      ].filter(d => d instanceof Date && !isNaN(d));

      if (allDates.length === 0) {
        timeline.innerHTML = `<div class="empty-state"><p>All dates are invalid. Please fix dates.</p></div>`;
        return;
      }

      let minDate = new Date(Math.min(...allDates));
      let maxDate = new Date(Math.max(...allDates));

      minDate.setDate(minDate.getDate() - 7);
      maxDate.setDate(maxDate.getDate() + 7);

      availableMonths = getMonthsBetween(minDate, maxDate);

      if (zoomStartMonth && zoomEndMonth) {
        minDate = new Date(zoomStartMonth);
        maxDate = new Date(zoomEndMonth);
        maxDate.setMonth(maxDate.getMonth() + 1);
        maxDate.setDate(0);
      }

      let totalDays = (maxDate - minDate) / MS_PER_DAY;
      if (!Number.isFinite(totalDays) || totalDays <= 0) totalDays = 1;

      const months = getMonthsBetween(minDate, maxDate);

      let html = '<div class="timeline-grid">';

      months.forEach((month, index) => {
        const monthStart = new Date(month);
        const monthEnd = new Date(month.getFullYear(), month.getMonth() + 1, 0);

        const startOffset = clamp01(((monthStart - minDate) / MS_PER_DAY) / totalDays * 100);
        const endOffset = clamp01(((monthEnd - minDate) / MS_PER_DAY) / totalDays * 100);
        const width = Math.max(0, endOffset - startOffset);

        html += `<div class="month-background ${index % 2 === 0 ? 'even' : 'odd'}" style="left: ${startOffset}%; width: ${width}%;"></div>`;
      });

      months.forEach(month => {
        const monthDate = new Date(month);
        const offset = clamp01(((monthDate - minDate) / MS_PER_DAY) / totalDays * 100);
        html += `<div class="grid-line month" style="left: ${offset}%;"></div>`;
      });

      milestones.forEach(milestone => {
        const milestoneDate = new Date(milestone.date);
        if (isNaN(milestoneDate)) return;
        const offset = clamp01(((milestoneDate - minDate) / MS_PER_DAY) / totalDays * 100);
        html += `<div class="grid-line milestone" style="left: ${offset}%;"></div>`;
      });

      html += '</div>';

      html += '<div class="timeline-content">';
      html += '<div class="timeline-header">';
      months.forEach(month => {
        const monthName = month.toLocaleString('default', {month: 'short', year: 'numeric'});
        html += `<div class="timeline-month">${monthName}</div>`;
      });
      html += '</div>';

      if (milestones.length > 0) {
        html += '<div class="milestones-row">';
        milestones.forEach(milestone => {
          const milestoneDate = new Date(milestone.date);
          if (isNaN(milestoneDate)) return;
          const offset = clamp01(((milestoneDate - minDate) / MS_PER_DAY) / totalDays * 100);
          html += `
            <div class="milestone-marker" style="left: ${offset}%;" onclick="openMilestoneModal(${milestone.id})">
             
              <div class="milestone-label" title="${milestone.label}">${milestone.label}</div>
            </div>
          `;
        });
        html += '</div>';
      }

      if (compactMode) {
        const groups = groupTasksForCompactView(tasks);

        groups.forEach(group => {
          html += '<div class="timeline-row" style="position: relative; height: 36px; margin-bottom: 8px;">';

          group.forEach(task => {
            const taskStart = new Date(task.startDate);
            const taskEnd = getEndDate(task.startDate, task.duration);

            if (isNaN(taskStart) || isNaN(taskEnd)) return;

            if (taskEnd < minDate || taskStart > maxDate) return;

            const startOffset = clamp01(((taskStart - minDate) / MS_PER_DAY) / totalDays * 100);
            const duration = clamp01(((taskEnd - taskStart) / MS_PER_DAY) / totalDays * 100);

            html += `
              <div class="task-bar" style="left: ${startOffset}%; width: ${duration}%; background: ${task.color};" 
                   onclick="openModal(${task.id})"
                   onmouseenter="showTooltip(event, ${JSON.stringify(task).replace(/"/g, '&quot;')})"
                   onmousemove="showTooltip(event, ${JSON.stringify(task).replace(/"/g, '&quot;')})"
                   onmouseleave="hideTooltip()">
                <div class="task-title">${task.title}</div>
              </div>
            `;
          });

          html += '</div>';
        });
      } else {
        tasks.forEach(task => {
          const taskStart = new Date(task.startDate);
          const taskEnd = getEndDate(task.startDate, task.duration);

          if (isNaN(taskStart) || isNaN(taskEnd)) {
            if (zoomStartMonth && zoomEndMonth) return;
            html += `
              <div class="timeline-row" draggable="true" data-task-id="${task.id}" 
                   ondragstart="handleDragStart(event)" 
                   ondragover="handleDragOver(event)" 
                   ondrop="handleDrop(event)" 
                   ondragend="handleDragEnd(event)">
                <span class="drag-handle">&#8942;&#8942;</span>
                <div style="margin-left: 40px; color:#a0aec0">Invalid date</div>
              </div>
            `;
            return;
          }

          if (taskEnd < minDate || taskStart > maxDate) return;

          const startOffset = clamp01(((taskStart - minDate) / MS_PER_DAY) / totalDays * 100);
          const duration = clamp01(((taskEnd - taskStart) / MS_PER_DAY) / totalDays * 100);

          html += `
            <div class="timeline-row" draggable="true" data-task-id="${task.id}" 
                 ondragstart="handleDragStart(event)" 
                 ondragover="handleDragOver(event)" 
                 ondrop="handleDrop(event)" 
                 ondragend="handleDragEnd(event)">
              <span class="drag-handle">&#8942;&#8942;</span>
              <div class="task-bar" style="left: ${startOffset}%; width: ${duration}%; background: ${task.color};" 
                   onclick="openModal(${task.id})"
                   onmouseenter="showTooltip(event, ${JSON.stringify(task).replace(/"/g, '&quot;')})"
                   onmousemove="showTooltip(event, ${JSON.stringify(task).replace(/"/g, '&quot;')})"
                   onmouseleave="hideTooltip()">
                <div class="task-title">${task.title}</div>
              </div>
            </div>
          `;
        });
      }

      html += '</div>';
      timeline.innerHTML = html;
    }

    function openModal(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;

      editingTaskId = taskId;
      document.getElementById('editTitle').value = task.title || '';
      document.getElementById('editStartDate').value = toISODate(task.startDate) || '';

      document.getElementById('editDuration').value = Number.isFinite(task.duration) && task.duration > 0 ? task.duration : '';

      const colorOptions = document.getElementById('colorOptions');
      colorOptions.innerHTML = colors.map(color =>
        `<div class="color-option ${color === task.color ? 'selected' : ''}" 
              style="background: ${color}" 
              data-color="${color}"
              onclick="selectColor('${color}')"></div>`
      ).join('');

      document.getElementById('modal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
      editingTaskId = null;
    }

    function selectColor(color) {
      document.querySelectorAll('.color-option').forEach(el => {
        el.classList.remove('selected');
      });
      const selectedEl = document.querySelector(`.color-option[data-color="${color}"]`);
      if (selectedEl) {
        selectedEl.classList.add('selected');
      }
    }

    function saveTask() {
      const task = tasks.find(t => t.id === editingTaskId);
      if (!task) return;

      const newTitle = document.getElementById('editTitle').value.trim();
      const newStartRaw = document.getElementById('editStartDate').value;
      const newDuration = parseInt(document.getElementById('editDuration').value);

      const newStart = toISODate(newStartRaw);

      if (!newTitle) {
        alert('Title cannot be empty');
        return;
      }
      if (!newStart) {
        alert('Please provide a valid start date (YYYY-MM-DD)');
        return;
      }
      if (!Number.isFinite(newDuration) || newDuration < 1) {
        alert('Please provide a valid duration (weeks, >= 1)');
        return;
      }

      task.title = newTitle;
      task.startDate = newStart;
      task.duration = newDuration;

      const selectedColor = document.querySelector('.color-option.selected');
      if (selectedColor) {
        task.color = selectedColor.getAttribute('data-color');
      }

      saveTasks();
      renderTimeline();
      closeModal();
    }

    let draggedTaskId = null;

    function handleDragStart(e) {
      draggedTaskId = parseInt(e.currentTarget.dataset.taskId);
      e.currentTarget.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragOver(e) {
      if (e.preventDefault) {
        e.preventDefault();
      }
      e.currentTarget.classList.add('drag-over');
      e.dataTransfer.dropEffect = 'move';
      return false;
    }

    function handleDrop(e) {
      if (e.stopPropagation) {
        e.stopPropagation();
      }

      const dropTaskId = parseInt(e.currentTarget.dataset.taskId);

      if (draggedTaskId !== dropTaskId) {
        const draggedIndex = tasks.findIndex(t => t.id === draggedTaskId);
        const dropIndex = tasks.findIndex(t => t.id === dropTaskId);

        const draggedTask = tasks[draggedIndex];
        tasks.splice(draggedIndex, 1);
        tasks.splice(dropIndex, 0, draggedTask);

        saveTasks();
        renderTimeline();
      }

      return false;
    }

    function handleDragEnd(e) {
      e.currentTarget.classList.remove('dragging');
      document.querySelectorAll('.timeline-row').forEach(row => {
        row.classList.remove('drag-over');
      });
    }

    function deleteTask() {
      if (!confirm('Are you sure you want to delete this task?')) return;

      tasks = tasks.filter(t => t.id !== editingTaskId);
      saveTasks();
      renderTimeline();
      closeModal();
    }

    document.getElementById('modal').addEventListener('click', (e) => {
      if (e.target.id === 'modal') closeModal();
    });

    document.getElementById('addMilestoneModal').addEventListener('click', (e) => {
      if (e.target.id === 'addMilestoneModal') closeAddMilestoneModal();
    });

    document.getElementById('milestoneModal').addEventListener('click', (e) => {
      if (e.target.id === 'milestoneModal') closeMilestoneModal();
    });

    function setupZoomSliders() {
      const startSlider = document.getElementById('zoomStartSlider');
      const endSlider = document.getElementById('zoomEndSlider');
      const zoomTrack = document.querySelector('.zoom-track');

      function updateZIndexBasedOnPosition(clientX) {
        if (!zoomTrack) return;
        const trackRect = zoomTrack.getBoundingClientRect();
        const mousePos = clientX - trackRect.left;
        const trackWidth = trackRect.width;
        const mousePercent = (mousePos / trackWidth) * 100;

        const startVal = parseInt(startSlider.value);
        const endVal = parseInt(endSlider.value);

        const distToStart = Math.abs(mousePercent - startVal);
        const distToEnd = Math.abs(mousePercent - endVal);

        if (distToEnd < distToStart) {
          endSlider.style.zIndex = '7';
          startSlider.style.zIndex = '4';
        } else {
          startSlider.style.zIndex = '7';
          endSlider.style.zIndex = '4';
        }
      }

      zoomTrack.addEventListener('mousemove', (e) => {
        updateZIndexBasedOnPosition(e.clientX);
      });

      zoomTrack.addEventListener('mouseleave', () => {
        startSlider.style.zIndex = '5';
        endSlider.style.zIndex = '4';
      });

      startSlider.addEventListener('mousedown', () => {
        startSlider.style.zIndex = '7';
        endSlider.style.zIndex = '4';
      });

      endSlider.addEventListener('mousedown', () => {
        endSlider.style.zIndex = '7';
        startSlider.style.zIndex = '4';
      });

      document.addEventListener('mouseup', () => {
        startSlider.style.zIndex = '5';
        endSlider.style.zIndex = '4';
      });

      startSlider.addEventListener('touchstart', () => {
        startSlider.style.zIndex = '7';
        endSlider.style.zIndex = '4';
      });

      endSlider.addEventListener('touchstart', () => {
        endSlider.style.zIndex = '7';
        startSlider.style.zIndex = '4';
      });

      document.addEventListener('touchend', () => {
        startSlider.style.zIndex = '5';
        endSlider.style.zIndex = '4';
      });
    }

    loadTasks();
    loadMilestones();
    setupZoomSliders();
    renderTimeline();
  </script>
</body>

</html>
